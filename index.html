<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortune Teller App</title>
    <!-- Tailwind CSS for styling -->
    <link rel="stylesheet" href="dist/output.css">
    <link rel="stylesheet" href="fonts.css">
    <style>
        /* Custom styles to match the design  */
        body {
            /* Background is now controlled by JS */
            background-size: cover;
            background-position: center;
            font-family: 'Hillray', serif;
            color: #EAE0D5;
            transition: background-image 0.5s ease-in-out;
        }

        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 15; /* Above content, below UI controls */
            pointer-events: none;
        }
        
        #app-container {
             position: relative;
             z-index: 10; /* Content container */
        }


        /* Theme classes for background */
        .theme-blue {
            background-image: url('./images/blue_carpet.png');
        }
        .theme-wood {
            background-image: url('./images/dark-old-wooden-table-texture-background-top-view-free-photo.jpg');
        }

        .font-title {
            font-family: 'Hillray', sans-serif;
            text-transform: uppercase;
            line-height: 1.1;
            position: relative;
            z-index: 1;
        }

        .font-body-text {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        
        .text-shadow {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .bg-paper-texture {
            background-image: url('./images/papertexture.png');
            background-size: cover;
            background-position: center;
        }

        /* General Button Style */
        .btn {
            border: 3px solid #5A4A3A;
            color: #991b1b;
            font-family: 'Hillray', sans-serif;
            text-transform: uppercase;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Carousel Styling */
        .card-container {
            display: flex;
            gap: 1rem;
            align-items: center;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 1rem 40px; 
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .card-container::-webkit-scrollbar { display: none; }

        .psychic-card {
            flex: 0 0 160px; 
            height: 240px;
            background-image: url('./images/papertexture.png');
            background-size: cover;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 8px;
            transition: transform 0.4s ease-in-out;
            transform: scale(0.85);
            cursor: pointer;
        }
         @media (min-width: 640px) {
            .psychic-card {
                flex: 0 0 192px; 
                height: 288px;
            }
        }
        
        .psychic-card img, .psychic-card video {
            width: 100%; height: 100%; object-fit: cover;
            border: 2px solid #5A4A3A; border-radius: 6px;
            transition: border-color 0.4s ease-in-out, border-width 0.4s ease-in-out;
        }

        .psychic-card.is-active { transform: scale(1.0); }
        .psychic-card.is-active img, .psychic-card.is-active video {
            border-color: #084873;
            border-width: 4px;
        }
        
        .carousel-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            background-color: rgba(0,0,0,0.4); border-radius: 50%;
            width: 40px; height: 40px; color: white; display: flex;
            align-items: center; justify-content: center; cursor: pointer; z-index: 10;
        }
        .arrow-left { left: 5px; }
        .arrow-right { right: 5px; }
        
        /* Topic Card Styling */
        .topic-card {
            padding: 0.5rem 1rem; border-radius: 12px; border: none;
            color: #3D2B1F; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-weight: bold; font-size: 1rem; cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 3px solid #5A4A3A;
        }
         @media (min-width: 640px) {
            .topic-card {
                padding: 0.75rem 1.5rem;
                font-size: 1.125rem;
            }
        }
        .topic-card:hover {
             box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
        }
        .topic-card.is-selected {
            background-image: none;
            background-color: #084873;
            color: #EAE0D5;
            border-color: #084873;
        }

        .screen {
            width: 100%; min-height: 100vh; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 1rem; opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .screen.active { display: flex; opacity: 1; }

        /* Prophecy Display Styling */
        #prophecy-display {
            padding: 1rem;
            max-width: 1000px;
        }
        #prophecy-image-container {
            max-width: 250px;
            margin: 0 auto;
        }
        @media (min-width: 768px) {
            #prophecy-image-container {
                max-width: 300px;
                margin: 0 auto;
            }
        }
        .prophecy-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            width: 100%;
        }
        @media (min-width: 768px) {
            .prophecy-content-wrapper {
                flex-direction: row;
                align-items: flex-start;
                gap: 2rem;
            }
        }
        #prophecy-text {
            color: #3D2B1F;
            text-align: left;
            line-height: 1.8;
        }
        .prophecy-text-card {
            background-image: url('./images/papertexture.png');
            background-size: cover;
            border: 3px solid #5A4A3A;
            padding: 1.5rem !important;
        }
        @media (min-width: 768px) {
            .prophecy-text-card {
                padding: 2rem !important;
            }
        }
        .prophecy-buttons {
            margin-top: 3rem !important;
            margin-bottom: 2rem !important;
        }
        
        .description { 
            width: 90%; 
            max-width: 600px; 
        }
        @media (min-width: 768px) {
            .description { width: 75%; }
        }
        @media (min-width: 1024px) {
            .description { width: 50%; }
        }

        /* Step 5 Form Styling */
        .form-card {
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4), inset 0 0 0 3px #5A4A3A;
            width: 90%;
            max-width: 400px;
        }
        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #5A4A3A;
            border-radius: 8px;
            padding: 0.75rem;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: #3D2B1F; /* Dark brown text color */
            font-weight: bold;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #084873; /* Blue border on focus */
        }
        .form-input::placeholder { color: rgba(61, 43, 31, 0.6); }
        .checkbox-label {
            display: flex; align-items: center; cursor: pointer;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: #3D2B1F; /* Dark brown text */
            font-weight: bold;
        }
        .custom-checkbox {
            width: 24px; height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #5A4A3A;
            border-radius: 4px;
            margin-right: 0.75rem;
            display: flex; align-items: center; justify-content: center;
            transition: border-color 0.2s;
        }
        input[type="checkbox"]:checked + .custom-checkbox {
            border-color: #084873;
        }
        .custom-checkbox svg { display: none; }
        input[type="checkbox"]:checked + .custom-checkbox svg { display: block; }
        input[type="checkbox"] { opacity: 0; width: 0; height: 0; position: absolute; }


        @media (max-height: 740px) {
            .screen h2 { margin-bottom: 1rem; }
            .screen .description { margin-top: 1rem; height: auto; }
        }
        
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
        }
        .theme-switch {
            display: none;
            height: 34px;
            position: relative;
            width: 60px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: #5A4A3A;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }
        .slider:before {
            background-color: #C6AD8F;
            bottom: 4px;
            content: "";
            height: 26px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 26px;
        }
        input:checked + .slider {
            background-color: #3D2B1F;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
        
        #start-video-container {
            position: relative;
            width: 300px;
            height: 450px;
            background-image: url('./images/papertexture.png');
            background-size: cover;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            padding: 8px;
        }
        .start-video {
            position: absolute;
            top: 8px;
            left: 8px;
            width: calc(100% - 16px);
            height: calc(100% - 16px);
            object-fit: cover;
            border-radius: 6px;
            opacity: 1;
        }

    </style>
    <link rel="icon" href="https://api.fortuneteller.zooglerfascht25.ch/wp-content/uploads/2025/06/web-app-manifest-512x512-1-150x150.png" sizes="32x32" />
    <link rel="icon" href="https://api.fortuneteller.zooglerfascht25.ch/wp-content/uploads/2025/06/web-app-manifest-512x512-1-300x300.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="https://api.fortuneteller.zooglerfascht25.ch/wp-content/uploads/2025/06/web-app-manifest-512x512-1-300x300.png" />
    <meta name="msapplication-TileImage" content="https://api.fortuneteller.zooglerfascht25.ch/wp-content/uploads/2025/06/web-app-manifest-512x512-1-300x300.png" />
</head>
<body class="theme-blue">
    <canvas id="particle-canvas"></canvas>

    <div id="theme-switcher" class="fixed top-4 right-4 z-50">
        <label class="theme-switch">
            <input type="checkbox" id="theme-toggle">
            <span class="slider round"></span>
        </label>
    </div>

    <div id="app-container" class="relative w-full h-full max-w-screen-xl mx-auto">
        <div id="step-1-decorations">
            <img src="./images/key.png" alt="Ancient Key" class="absolute top-8 left-8 w-24 md:w-32 lg:w-48 transform -rotate-12 hidden sm:block">
            <img src="./images/book.png" alt="Ancient Book" class="absolute bottom-8 left-4 w-52 md:w-64 lg:w-[25rem] transform rotate-6 hidden sm:block">
            <img src="./images/candlelight.png" alt="Candlelight and Stones" class="absolute top-8 right-8 w-40 md:w-48 lg:w-64 candle-glow hidden sm:block">
            <img src="./images/invitation.png" alt="Invitation" class="absolute bottom-8 right-8 w-56 md:w-64 lg:w-96 transform -rotate-6 hidden sm:block">
        </div>

        <div id="step-1" class="screen active pb-32">
             <h1 class="font-title text-shadow mb-8">
                <span class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl text-white">Get your prophecy</span><br>
                <span class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-yellow-400">from our seers!</span>
            </h1>
            <div id="start-video-container" class="mb-8">
                <video class="start-video" src="./images/video1.mp4" autoplay loop muted playsinline></video>
            </div>
        </div>

        <div id="step-2" class="screen pb-32">
             <h2 class="font-title text-shadow mb-8">
                <span class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl text-white">How do you want to</span><br>
                <span class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-yellow-400">hear your destiny?</span>
            </h2>
            <div class="relative w-full max-w-5xl">
                <div id="step-2-arrow-left" class="carousel-arrow arrow-left"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></div>
                <div id="step-2-card-container" class="card-container">
                    <div class="psychic-card" data-index="0" data-level="1"><img src="./images/google_level1.png" alt="The Internal Hype Machine"></div>
                    <div class="psychic-card" data-index="1" data-level="2"><img src="./images/google_level2.png" alt="The Unverified Alpha Test"></div>
                    <div class="psychic-card" data-index="2" data-level="3"><img src="./images/google_level3.png" alt="The Disruptor's Memo"></div>
                </div>
                <div id="step-2-arrow-right" class="carousel-arrow arrow-right"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></div>
            </div>
            <div id="step-2-description" class="description h-24 mt-8">
                <h3 id="step-2-title" class="font-title text-2xl text-white"></h3>
                <p id="step-2-text" class="text-lg font-body-text"></p>
            </div>
        </div>

        <div id="step-3" class="screen pb-32" style="padding-bottom: 7rem;">
             <h2 class="font-title text-shadow mb-8">
                <span class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl text-white">Choose 3 topics – </span><br>
                <span class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-yellow-400">we'll tell you what's coming.</span>
            </h2>
            <div id="topic-container" class="flex flex-wrap justify-center gap-3 sm:gap-4 max-w-3xl"></div>
        </div>

        <div id="step-4" class="screen pb-32">
            <h2 class="font-title text-shadow mb-8">
                <span class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl text-white">What's your</span><br>
                <span class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-yellow-400">first name?</span>
            </h2>
            <div class="form-card bg-paper-texture">
                <form id="contact-form" autocomplete="off">
                    <input type="text" id="vorname" name="vorname" placeholder="Your first name" class="form-input">
                </form>
            </div>
        </div>

        <div id="step-5" class="screen pb-32">
            <div id="loading-prophecy" class="flex flex-col items-center">
                <h2 class="font-title text-shadow mb-8">
                    <span class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl text-white">Generating your</span><br>
                    <span class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-yellow-400">prophecy...</span>
                </h2>
            </div>
            <div id="prophecy-display" class="hidden flex flex-col items-center mx-auto w-full">
                <h2 class="font-title text-shadow mb-6">
                    <span class="text-3xl sm:text-4xl md:text-5xl text-white">Your prophecy</span><br>
                    <span class="text-2xl sm:text-3xl md:text-4xl text-yellow-400">has been revealed!</span>
                </h2>
                <div class="prophecy-content-wrapper mb-6">
                    <div id="prophecy-image-container" class="flex-shrink-0">
                        <div class="bg-paper-texture rounded-lg shadow-lg p-2">
                            <img id="prophecy-image" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Fortune Teller" class="w-full rounded border-2 border-yellow-700">
                        </div>
                    </div>
                    <div class="prophecy-text-card rounded-lg shadow-lg" style="flex: 1; min-width: 0;">
                        <p id="prophecy-text" class="text-base md:text-lg font-body-text whitespace-pre-wrap"></p>
                    </div>
                </div>
                <div class="prophecy-buttons flex flex-col sm:flex-row gap-4 items-center justify-center">
                    <button id="get-video-btn" class="btn bg-paper-texture px-10 py-3 text-lg sm:text-xl">Get as Video via SMS</button>
                    <button id="skip-video-btn" class="btn bg-paper-texture px-10 py-3 text-lg sm:text-xl opacity-70 hover:opacity-100">No thanks</button>
                </div>
            </div>
        </div>

        <div id="step-6" class="screen pb-32">
            <h2 class="font-title text-shadow mb-8">
                <span class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl text-white">Want your prophecy</span><br>
                <span class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-yellow-400">as a video?</span>
            </h2>
            <div class="form-card bg-paper-texture">
                <form id="video-form" autocomplete="off">
                    <input type="tel" id="handy" name="handy" value="+41" placeholder="Mobile number (no spam, promised)" class="form-input">
                </form>
            </div>
        </div>

        <div id="step-7" class="screen">
             <h2 class="font-title text-shadow mb-8">
                <span class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl text-white">Your prophecy will arrive</span><br>
                <span class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-yellow-400">SHORTLY BY SMS.</span>
            </h2>
            <p class="text-lg font-body-text max-w-md mb-4">Until then: Get yourself a magic potion at the bar – who knows, maybe it'll make you even more clairvoyant!</p>
            <p class="text-sm font-body-text max-w-md opacity-70">Your SMS will arrive in approximately 10 minutes.</p>
        </div>

        <!-- Navigation Buttons -->
        <div id="nav-container" class="fixed bottom-0 left-0 right-0 p-4 flex justify-center z-20">
            <button id="start-btn" class="btn bg-paper-texture px-16 py-4 text-2xl sm:text-3xl">Show me my destiny</button>
            <div id="step-nav" class="hidden w-full max-w-md flex justify-between gap-4">
                <button id="back-btn" class="btn bg-paper-texture w-1/2 py-3 text-xl sm:text-2xl">Back</button>
                <button id="next-btn" class="btn bg-paper-texture w-1/2 py-3 text-xl sm:text-2xl" disabled>Next</button>
            </div>
             <button id="neustart-btn" class="hidden btn bg-paper-texture px-16 py-4 text-2xl sm:text-3xl">Restart</button>
        </div>
    </div>
    <script src="./dist/cleave.min.js"></script>
    <script src="./dist/cleave-phone.ch.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {

            // ––– 0) Cleave für CH-Handy
            const phoneInput = document.getElementById('handy');
            const cleavePhone = new Cleave(phoneInput, {
                phone: true,
                phoneRegionCode: 'CH',
                delimiter: ' '
            });

            // 1. Partikel-Hintergrund
            const setupParticleEffect = () => {
                const canvas = document.getElementById('particle-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                let particlesArray = [];

                class Particle {
                    constructor() {
                        this.x = Math.random() * canvas.width;
                        this.y = Math.random() * canvas.height;
                        this.size = Math.random() * 2 + 1;
                        this.speedX = Math.random() * 0.2 - 0.1;
                        this.speedY = Math.random() * 0.2 - 0.1;
                        this.opacity = Math.random() * 0.3 + 0.1;
                    }
                    update() {
                        this.x += this.speedX; this.y += this.speedY;
                        if (this.x > canvas.width || this.x < 0) this.speedX *= -1;
                        if (this.y > canvas.height || this.y < 0) this.speedY *= -1;
                    }
                    draw() {
                        ctx.fillStyle = `rgba(234, 224, 213, ${this.opacity})`;
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                const initParticles = () => {
                    particlesArray = [];
                    const numberOfParticles = (canvas.width * canvas.height) / 9000;
                    for (let i = 0; i < numberOfParticles; i++) {
                        particlesArray.push(new Particle());
                    }
                };
                const animateParticles = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particlesArray.forEach(p => { p.update(); p.draw(); });
                    requestAnimationFrame(animateParticles);
                };

                initParticles();
                animateParticles();
                window.addEventListener('resize', () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    initParticles();
                });
            };


            // 3. App-State, Navigation und UI-Elemente
            const appState = {
                selections: {
                    wahrsagerId: null, // Auto-selected from API
                    'step-2': { index: null, level: null },
                    'step-3': []
                },
                formData: { vorname: '', handy: '' },
                prophecy: { uuid: null, text: '', image: '' }
            };
            let currentStep = 1;
            const totalSteps = 7;
            const screens = document.querySelectorAll('.screen');
            const startBtn = document.getElementById('start-btn');
            const backBtn = document.getElementById('back-btn');
            const nextBtn = document.getElementById('next-btn');
            const stepNav = document.getElementById('step-nav');
            const step1Decorations = document.getElementById('step-1-decorations');
            const neustartBtn = document.getElementById('neustart-btn');
            const themeToggle = document.getElementById('theme-toggle');

            // 4. REST-Call für Wahrsager-Daten - auto-select first one
            let wahrsagerList = [];
            async function loadWahrsagerData() {
                try {
                    const res = await fetch('https://api.fortuneteller.zooglerfascht25.ch/wp-json/wahrsager/v1/list');
                    wahrsagerList = await res.json();
                    // Auto-select first Wahrsager
                    if (wahrsagerList.length > 0) {
                        appState.selections.wahrsagerId = wahrsagerList[0].id;
                    }
                } catch (e) {
                    console.error('Could not load fortune teller data:', e);
                }
            }

            // 5. Carousel-, Topic- und Formular-Logik
            const stepData = {
                'step-2': {
                    descriptions: [
                        { title: "The Internal Hype Machine", text: "Optimistic and energizing – your future served with a side of unlimited snacks and upbeat vibes." },
                        { title: "The Unverified Alpha Test", text: "Honest and straightforward – like a code review that tells you what you need to hear, not what you want." },
                        { title: "The Disruptor's Memo", text: "Bold and unfiltered – your cards won't sugarcoat it, they'll launch it into production without testing." }
                    ],
                    titleElement: document.getElementById('step-2-title'),
                    textElement:  document.getElementById('step-2-text')
                }
            };

            const setupCarousel = (carouselId) => {
                const container = document.getElementById(`${carouselId}-card-container`);
                if (!container) return;
                const cards = Array.from(container.querySelectorAll('.psychic-card'));
                const arrowLeft = document.getElementById(`${carouselId}-arrow-left`);
                const arrowRight = document.getElementById(`${carouselId}-arrow-right`);
                const carouselData = stepData[carouselId];
                let activeCardIndex = -1, isAnimating = false;

                const updateCarouselPadding = () => {
                    if (!cards.length) return;
                    const side = Math.max(20, (container.offsetWidth/2) - (cards[0].offsetWidth/2));
                    container.style.paddingLeft = container.style.paddingRight = `${side}px`;
                };

                const setActiveCard = (index, behavior = 'smooth') => {
                    if (isAnimating && behavior==='smooth') return;
                    if (index<0||index>=cards.length) return;
                    if (behavior==='smooth') isAnimating=true;
                    cards[activeCardIndex]?.classList.remove('is-active');
                    activeCardIndex=index;
                    const active=cards[activeCardIndex];
                    // Step 2 is now the level selection
                    appState.selections['step-2']={ index, level: active.dataset.level };
                    active.classList.add('is-active');
                    const desc=carouselData.descriptions[index%carouselData.descriptions.length];
                    carouselData.titleElement.textContent = desc.title;
                    carouselData.textElement.textContent = desc.text;
                    const scrollPos = active.offsetLeft - (container.offsetWidth/2) + (active.offsetWidth/2);
                    container.scrollTo({ left: scrollPos, behavior });
                    setTimeout(()=>{ isAnimating=false; }, 400);
                    checkNextButtonStatus();
                };

                cards.forEach((c,i)=>c.addEventListener('click',()=>setActiveCard(i)));
                arrowLeft.addEventListener('click',()=>setActiveCard((activeCardIndex-1+cards.length)%cards.length));
                arrowRight.addEventListener('click',()=>setActiveCard((activeCardIndex+1)%cards.length));
                window.addEventListener('resize',()=>{ updateCarouselPadding(); setActiveCard(activeCardIndex,'auto'); });
                updateCarouselPadding();
                setActiveCard(Math.floor(cards.length/2),'auto');
            };

            const setupTopicSelector = () => {
                const topics = [
                    "The Next Viral Meme Strategy",
                    "The AI That Learned to Procrastinate",
                    "My Desk Plant's True Purpose",
                    "Hidden Easter Eggs in Search Results",
                    "Data Center Snack Evolution",
                    "Predicting the Next Major Tool Outage",
                    "The Future of Meeting Etiquette",
                    "My Next Great WFH Purchase"
                ];
                const container = document.getElementById('topic-container');
                container.innerHTML = '';
                topics.forEach(topic => {
                    const btn = document.createElement('button');
                    btn.className = 'topic-card bg-paper-texture';
                    btn.textContent = topic;
                    if (appState.selections['step-3'].includes(topic)) btn.classList.add('is-selected');
                    btn.addEventListener('click', () => {
                        const sel = appState.selections['step-3'];
                        if (btn.classList.toggle('is-selected')) {
                            if (sel.length<3) sel.push(topic);
                            else btn.classList.remove('is-selected');
                        } else {
                            appState.selections['step-3'] = sel.filter(t=>t!==topic);
                        }
                        checkNextButtonStatus();
                    });
                    container.appendChild(btn);
                });
            };

            function setupForm() {
                const form = document.getElementById('contact-form');
                const vor = document.getElementById('vorname');
                vor.value = appState.formData.vorname || '';
                form.addEventListener('input', () => {
                    appState.formData.vorname = vor.value.trim();
                    checkNextButtonStatus();
                });
            }

            function setupVideoForm() {
                const form = document.getElementById('video-form');
                const tel = document.getElementById('handy');
                tel.value = appState.formData.handy || '+41';
                form.addEventListener('input', () => {
                    appState.formData.handy = tel.value.trim();
                    checkNextButtonStatus();
                });
            }

            const validatePhoneNumber = phone => {
                let raw = phone.replace(/\D/g,'');
                // +41 / 41 → 0 umwandeln
                if (raw.startsWith('41') && raw.length === 11) {
                    raw = '0' + raw.slice(2);
                }
                return /^0\d{9}$/.test(raw);
            };

            const checkNextButtonStatus = () => {
                let en=false;
                if (currentStep===2) en = appState.selections['step-2'].index!==null;
                if (currentStep===3) en = appState.selections['step-3'].length===3;
                if (currentStep===4) {
                    const { vorname } = appState.formData;
                    en = vorname && vorname.length > 0;
                }
                if (currentStep===6) {
                    const { handy } = appState.formData;
                    en = handy && validatePhoneNumber(handy);
                }
                nextBtn.disabled = !en;
            };

            // Call 1: Get text and image prophecy (without tel)
            const callGetTextAPI = async () => {
                const base = 'https://api.fortuneteller.zooglerfascht25.ch/wp-json/wahrsager/v1/gettext';
                const p = new URLSearchParams();
                const { vorname } = appState.formData;
                if (vorname) p.append('firstname', vorname);
                [...appState.selections['step-3']].forEach((t, i) => p.append(`passion${i+1}`, t));
                p.append('wahrsagerId', appState.selections.wahrsagerId);
                p.append('level', appState.selections['step-2'].level);

                const url = `${base}?${p}`;
                console.log('Call 1 - Get Text API:', url);

                try {
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.uuid && data.text && data.image) {
                        appState.prophecy.uuid = data.uuid;
                        appState.prophecy.text = data.text;
                        appState.prophecy.image = data.image;
                        return true;
                    } else {
                        console.error('Invalid response from API:', data);
                        alert('Fehler beim Erstellen der Prophezeiung. Bitte versuche es erneut.');
                        return false;
                    }
                } catch (e) {
                    console.error('Error calling gettext API:', e);
                    alert('Fehler beim Erstellen der Prophezeiung. Bitte versuche es erneut.');
                    return false;
                }
            };

            // Call 2: Generate video with phone number
            const callGenerateVideoAPI = async () => {
                const base = 'https://api.fortuneteller.zooglerfascht25.ch/wp-json/wahrsager/v1/generate-video';
                const { handy } = appState.formData;

                // Convert phone to international format
                let raw = handy.replace(/\D/g, '');
                if (raw.startsWith('0') && raw.length === 10) {
                    raw = '41' + raw.slice(1);
                } else if (raw.startsWith('0041') && raw.length === 12) {
                    raw = raw.slice(2);
                } else if (raw.startsWith('41') && raw.length === 11) {
                    // already correct
                } else {
                    console.warn('Invalid phone format:', handy);
                }

                const payload = {
                    uuid: appState.prophecy.uuid,
                    tel: raw
                };

                console.log('Call 2 - Generate Video API:', base, payload);

                try {
                    const response = await fetch(base, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();

                    if (data.status === 'video_generation_started') {
                        return true;
                    } else {
                        console.error('Invalid response from video API:', data);
                        alert('Fehler beim Starten der Video-Generierung. Bitte versuche es erneut.');
                        return false;
                    }
                } catch (e) {
                    console.error('Error calling generate-video API:', e);
                    alert('Fehler beim Starten der Video-Generierung. Bitte versuche es erneut.');
                    return false;
                }
            };

            const handleFormSubmission = async () => {
                appState.formData.vorname = document.getElementById('vorname').value.trim();
                showStep(5);

                // Show loading state
                document.getElementById('loading-prophecy').style.display = 'flex';
                document.getElementById('prophecy-display').classList.add('hidden');

                // Call API to get text and image
                const success = await callGetTextAPI();

                if (success) {
                    // Hide loading and show prophecy
                    document.getElementById('loading-prophecy').style.display = 'none';
                    document.getElementById('prophecy-display').classList.remove('hidden');
                    document.getElementById('prophecy-text').textContent = appState.prophecy.text;
                    document.getElementById('prophecy-image').src = appState.prophecy.image;
                } else {
                    // Go back to step 4 on error
                    showStep(4);
                }
            };

            const handleVideoSubmission = async () => {
                appState.formData.handy = document.getElementById('handy').value.trim();

                // Disable button during API call
                nextBtn.disabled = true;
                nextBtn.textContent = 'Sending...';

                const success = await callGenerateVideoAPI();

                if (success) {
                    showStep(7);
                } else {
                    // Re-enable button on error
                    nextBtn.disabled = false;
                    nextBtn.textContent = 'Submit';
                }
            };

            const showStep = step => {
                currentStep = step;
                screens.forEach(s=>s.classList.remove('active'));
                document.getElementById(`step-${step}`)?.classList.add('active');
                step1Decorations.style.display = step===1 ? 'block' : 'none';
                startBtn.style.display = step===1 ? 'block' : 'none';
                stepNav.style.display   = (step>1&&step<=4) || step===6 ? 'flex' : 'none';
                neustartBtn.style.display = step===7 ? 'block' : 'none';

                // Update next button text
                if (step===4) nextBtn.textContent = 'Show my prophecy';
                else if (step===6) nextBtn.textContent = 'Send Video';
                else nextBtn.textContent = 'Next';

                checkNextButtonStatus();
                if (step===2) setTimeout(() => setupCarousel('step-2'), 50);
                if (step===3) setupTopicSelector();
                if (step===4) setupForm();
                if (step===6) setupVideoForm();
            };

            const resetApp = () => {
                appState.selections = { wahrsagerId: wahrsagerList[0]?.id || null, 'step-2': {index:null}, 'step-3':[] };
                appState.formData   = { vorname:'', handy:'' };
                appState.prophecy   = { uuid: null, text: '', image: '' };
                document.getElementById('contact-form').reset();
                if (document.getElementById('video-form')) {
                    document.getElementById('video-form').reset();
                }
                showStep(1);
            };

            // Event-Bindings
            themeToggle.addEventListener('change', () => {
                document.body.classList.toggle('theme-wood', themeToggle.checked);
                document.body.classList.toggle('theme-blue', !themeToggle.checked);
            });
            startBtn.addEventListener('click', () => showStep(2));
            nextBtn.addEventListener('click', () => {
                if (currentStep===4) return handleFormSubmission();
                if (currentStep===6) return handleVideoSubmission();
                if (currentStep<totalSteps) showStep(currentStep+1);
            });
            backBtn.addEventListener('click', () => {
                // Don't allow going back from step 5 (prophecy display)
                if (currentStep>1 && currentStep!==5) showStep(currentStep-1);
            });
            neustartBtn.addEventListener('click', resetApp);

            // Get Video button - goes to step 6 (phone input)
            document.getElementById('get-video-btn').addEventListener('click', () => {
                showStep(6);
            });

            // Skip Video button - restarts the app
            document.getElementById('skip-video-btn').addEventListener('click', () => {
                resetApp();
            });

            // 6. Initialisierung
            await loadWahrsagerData();
            showStep(1);
            setupParticleEffect();

        });
    </script>

</body>
</html>
